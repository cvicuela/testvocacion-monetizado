[build]
publish = "."
command = "npm install --prefix netlify/functions"

[functions]
directory = "netlify/functions"
node_bundler = "esbuild"

# ============================================================================
# SECURITY HEADERS - Apply to all content
# ============================================================================

[[headers]]
for = "/*"
[headers.values]
  # HSTS: Force HTTPS for 1 year, include subdomains, preload
  Strict-Transport-Security = "max-age=31536000; includeSubDomains; preload"

  # Prevent content type sniffing attacks
  X-Content-Type-Options = "nosniff"

  # Clickjacking protection - prevent framing in other sites
  X-Frame-Options = "DENY"

  # XSS protection for older browsers
  X-XSS-Protection = "1; mode=block"

  # Referrer policy - privacy focused
  Referrer-Policy = "strict-origin-when-cross-origin"

  # Permissions policy - restrict dangerous features
  Permissions-Policy = "geolocation=(), microphone=(), camera=(), payment=(self)"

  # Content Security Policy - strict, prevents XSS and injection attacks
  Content-Security-Policy = "default-src 'self'; script-src 'self' 'unsafe-inline' https://www.paypal.com https://checkout.stripe.com https://fonts.googleapis.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://www.paypal.com https://checkout.stripe.com https://api.stripe.com https://lqdodhyovotxyjhinjgd.supabase.co https://www.google-analytics.com; frame-src https://www.paypal.com https://checkout.stripe.com; base-uri 'self'; form-action 'self'"

# ============================================================================
# SECURITY HEADERS - API Functions (Restricted CORS)
# ============================================================================

[[headers]]
for = "/.netlify/functions/*"
[headers.values]
  # Only allow requests from same domain and specific trusted origins
  Access-Control-Allow-Origin = "https://testvocacion.netlify.app"

  # Only allow necessary headers
  Access-Control-Allow-Headers = "Content-Type, Authorization"

  # Only allow POST and OPTIONS methods
  Access-Control-Allow-Methods = "POST, OPTIONS"

  # Prevent browser from caching credentials
  Access-Control-Allow-Credentials = "false"

  # Max age for CORS preflight cache
  Access-Control-Max-Age = "86400"

  # Security headers for API responses
  X-Content-Type-Options = "nosniff"
  X-Frame-Options = "DENY"
  Strict-Transport-Security = "max-age=31536000; includeSubDomains; preload"

# ============================================================================
# Cache Headers - Static assets
# ============================================================================

[[headers]]
for = "/*.{js,css,woff,woff2,ttf,eot,svg}"
[headers.values]
  Cache-Control = "public, max-age=31536000, immutable"
  X-Content-Type-Options = "nosniff"

[[headers]]
for = "/*.{jpg,jpeg,png,gif,webp}"
[headers.values]
  Cache-Control = "public, max-age=2592000"
  X-Content-Type-Options = "nosniff"

# ============================================================================
# HTML pages - No cache (always check for updates)
# ============================================================================

[[headers]]
for = "/*.html"
[headers.values]
  Cache-Control = "public, max-age=0, must-revalidate"
  X-Content-Type-Options = "nosniff"
  X-Frame-Options = "DENY"

# ============================================================================
# Redirects for security
# ============================================================================

# Ensure all HTTP traffic redirects to HTTPS (handled by Netlify automatically)
# But we can add explicit rules below if needed

[[redirects]]
from = "http://testvocacion.netlify.app/*"
to = "https://testvocacion.netlify.app/:splat"
status = 301
force = true
